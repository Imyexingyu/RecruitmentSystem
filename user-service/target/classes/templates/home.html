<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>用户首页</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            height: 100vh;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar {
            height: calc(100vh - 56px);
            background-color: #f8f9fa;
            padding-top: 1rem;
            border-right: 1px solid #dee2e6;
            border-top-left-radius: 16px;
            border-bottom-left-radius: 16px;
            box-shadow: 2px 0 12px rgba(102,126,234,0.07);
        }
        .sidebar a {
            display: block;
            padding: 12px 18px;
            color: #333;
            text-decoration: none;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 8px;
            font-weight: 500;
            transition: background 0.2s, color 0.2s;
        }
        .sidebar a:hover, .sidebar a.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .main-content {
            padding: 36px 28px;
            background-color: #fff;
            min-height: calc(100vh - 56px);
            border-radius: 0 16px 16px 0;
            box-shadow: 0 4px 24px rgba(102,126,234,0.08);
        }
        .navbar .dropdown-menu {
            right: 0;
            left: auto;
        }
        #editProfileForm .form-group label {
            font-weight: bold;
        }
        #msg {
            margin-top: 10px;
        }
        @media (max-width: 900px) {
            .main-content {
                padding: 18px 4px;
            }
        }
        @media (max-width: 768px) {
            .sidebar {
                border-radius: 0;
                box-shadow: none;
            }
            .main-content {
                border-radius: 0;
                box-shadow: none;
                padding: 10px 2px;
            }
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <a class="navbar-brand" href="#">招聘系统</a>
    <div class="ml-auto">
        <ul class="navbar-nav">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown">
                    <span th:text="${username}">用户名</span>
                </a>
                <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="#" onclick="logout()">退出登录</a>
                </div>
            </li>
        </ul>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar">
            <a onclick="loadPage('job-list')">职位列表</a>
            <a onclick="loadPage('search-jobs')">职位搜索</a>
            <a onclick="loadPage('interviews')">面试管理</a>
            <a onclick="loadPage('notifications')">通知中心</a>
            <a onclick="loadPage('edit-profile')">编辑信息</a>
            <a onclick="loadPage('resume')">简历管理</a>
        </div>

        <div class="col-md-10 main-content" id="mainContent">
            <h4>欢迎来到用户中心，请选择左侧功能。</h4>
        </div>
    </div>
</div>

<script>
    const currentUserId = 123; // 可替换为实际登录用户 ID

    function loadPage(page) {
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = "<p>加载中...</p>";

        if (page === 'job-list') {
            fetch('http://localhost:9501/jobs/all')
                .then(res => res.json())
                .then(data => {
                    let html = `
            <h4>职位列表</h4>
            <table class="table table-bordered mt-3">
              <thead><tr><th>职位名称</th><th>地点</th><th>薪资</th><th>操作</th></tr></thead>
              <tbody>`;
                    data.forEach(job => {
                        html += `
              <tr>
                <td>${job.title}</td>
                <td>${job.location}</td>
                <td>${job.salary}</td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="applyJob(${job.id})">投递</button>
                  <button class="btn btn-sm btn-info" onclick="viewJobDetail(${job.id})">查看详情</button>
                </td>
              </tr>`;
                    });
                    html += '</tbody></table>';
                    mainContent.innerHTML = html;
                })
                .catch(() => {
                    mainContent.innerHTML = '<p class="text-danger">职位加载失败</p>';
                });

        } else if (page === 'search-jobs') {
            mainContent.innerHTML = `
                <h4 class="mb-3">职位搜索</h4>
                <div class="card" style="border-radius: 12px; box-shadow: 0 4px 12px rgba(102,126,234,0.12);">
                    <div class="card-body">
                        <div class="form-inline mb-2">
                            <input class="form-control mr-2" id="searchKeyword" placeholder="请输入关键字" />
                            <button class="btn btn-primary" onclick="searchJobs()">搜索</button>
                        </div>
                        <div class="mt-3">
                            <table class="table table-bordered table-hover">
                                <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <tr>
                                        <th>职位名称</th>
                                        <th>公司</th>
                                        <th>地点</th>
                                        <th>薪资</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="searchResult">
                                    <tr>
                                        <td colspan="5" class="text-center">请输入关键词搜索</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        } else if (page === 'edit-profile') {
            mainContent.innerHTML = `
        <h4 class="mb-4">编辑信息</h4>
        <form id="editProfileForm" class="w-75">
          <input type="hidden" id="user_id" />
          <div class="form-group row">
            <label for="name" class="col-sm-2 col-form-label">姓名</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="name" />
            </div>
          </div>
          <div class="form-group row">
            <label for="gender" class="col-sm-2 col-form-label">性别</label>
            <div class="col-sm-10">
              <select class="form-control" id="gender">
                <option value="男">男</option>
                <option value="女">女</option>
              </select>
            </div>
          </div>
          <div class="form-group row">
            <label for="birthday" class="col-sm-2 col-form-label">生日</label>
            <div class="col-sm-10">
              <input type="date" class="form-control" id="birthday" />
            </div>
          </div>
          <div class="form-group row">
            <label for="education" class="col-sm-2 col-form-label">学历</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="education" />
            </div>
          </div>
          <div class="form-group row">
            <label for="experience" class="col-sm-2 col-form-label">经验</label>
            <div class="col-sm-10">
              <textarea class="form-control" id="experience" rows="3"></textarea>
            </div>
          </div>
          <div class="form-group row">
            <label for="skills" class="col-sm-2 col-form-label">技能</label>
            <div class="col-sm-10">
              <textarea class="form-control" id="skills" rows="3"></textarea>
            </div>
          </div>
          <div class="form-group row">
            <div class="col-sm-10 offset-sm-2">
              <button type="submit" class="btn btn-primary">保存信息</button>
            </div>
          </div>
        </form>
        <div id="msg" class="ml-3"></div>`;

            fetch(`http://localhost:9501/user/info`)
                .then(res => res.json())
                .then(data => {
                    if (data) {
                        document.getElementById('user_id').value = data.user_id || '';
                        document.getElementById('name').value = data.name || '';
                        document.getElementById('gender').value = data.gender || '男';
                        document.getElementById('birthday').value = data.birthday ? data.birthday.split('T')[0] : '';
                        document.getElementById('education').value = data.education || '';
                        document.getElementById('experience').value = data.experience || '';
                        document.getElementById('skills').value = data.skills || '';
                    }
                })
                .catch(() => {
                    document.getElementById('msg').style.color = 'red';
                    document.getElementById('msg').textContent = '加载用户信息失败';
                });

            document.getElementById('editProfileForm').onsubmit = function (e) {
                e.preventDefault();
                const candidate = {
                    user_id: document.getElementById('user_id').value,
                    name: document.getElementById('name').value,
                    gender: document.getElementById('gender').value,
                    birthday: document.getElementById('birthday').value,
                    education: document.getElementById('education').value,
                    experience: document.getElementById('experience').value,
                    skills: document.getElementById('skills').value,
                    avatar: ''
                };

                fetch('http://localhost:9501/user/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(candidate)
                })
                    .then(res => res.text())
                    .then(msg => {
                        const msgDiv = document.getElementById('msg');
                        msgDiv.style.color = 'green';
                        msgDiv.textContent = msg;
                    })
                    .catch(() => {
                        const msgDiv = document.getElementById('msg');
                        msgDiv.style.color = 'red';
                        msgDiv.textContent = '保存失败';
                    });
            };
        } else if (page === 'resume') {
            mainContent.innerHTML = `
        <h4>简历管理</h4>
        <div class="card mb-4" style="border-radius: 12px; box-shadow: 0 4px 12px rgba(102,126,234,0.12);">
            <div class="card-body">
                <h5 class="card-title">简历上传与修改</h5>
                <p class="card-text">上传、修改简历内容，完善个人信息</p>
                <button id="goBookPageBtn" class="btn btn-primary">去简历管理页面</button>
            </div>
        </div>
        
        <div class="card" style="border-radius: 12px; box-shadow: 0 4px 12px rgba(102,126,234,0.12);">
            <div class="card-body">
                <h5 class="card-title">我的投递</h5>
                <div id="myApplications">
                    <p class="text-center">加载中...</p>
                </div>
            </div>
        </div>
    `;
            // 绑定按钮点击事件跳转
            document.getElementById('goBookPageBtn').onclick = function () {
                window.location.href = 'http://localhost:9501/book.html';
            }
            
            // 加载我的投递数据
            loadMyApplications();
        } else if (page === 'interviews') {
            mainContent.innerHTML = `
                <h4>面试管理</h4>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">我的面试</h5>
                            <div>
                                <button class="btn btn-primary" onclick="loadMyInterviews()">刷新列表</button>
                            </div>
                        </div>
                        <div id="interviewList">
                            <p class="text-center">加载中...</p>
                        </div>
                    </div>
                </div>`;
            
            loadMyInterviews();

        } else if (page === 'notifications') {
            mainContent.innerHTML = `
                <h4>通知中心</h4>
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 class="card-title" id="totalNotifications">0</h3>
                                        <p class="card-text">总通知数</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 class="card-title" id="unreadNotifications">0</h3>
                                        <p class="card-text">未读通知</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 class="card-title" id="todayNotifications">0</h3>
                                        <p class="card-text">今日通知</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">通知列表</h5>
                            <div>
                                <button class="btn btn-primary mr-2" onclick="loadUserNotifications()">刷新通知</button>
                                <button class="btn btn-success" onclick="markAllNotificationsAsRead()">全部标记已读</button>
                            </div>
                        </div>
                        <div id="notificationList">
                            <p class="text-center">加载中...</p>
                        </div>
                    </div>
                </div>`;
            
            loadUserNotifications();
        }
    }
    
    function loadMyApplications() {
        const myApplicationsDiv = document.getElementById('myApplications');
        if (!myApplicationsDiv) return;
        
        let token = getCookie('token') || localStorage.getItem('jwtToken');
        let user = parseJwt(token);
        if (!user) {
            myApplicationsDiv.innerHTML = '<p class="text-danger">请先登录查看投递记录</p>';
            return;
        }
        
        const candidateId = user.id || user.user_id;
        
        fetch(`http://localhost:9501/jobs/jobseeker/${candidateId}`)
            .then(res => res.json())
            .then(applications => {
                if (!applications || applications.length === 0) {
                    myApplicationsDiv.innerHTML = '<p class="text-center">暂无投递记录</p>';
                    return;
                }
                
                let html = `
                <table class="table table-bordered table-hover">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th>投递序号</th>
                            <th>职位ID</th>
                            <th>投递时间</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="applicationsTableBody"></tbody>
                </table>`;
                
                myApplicationsDiv.innerHTML = html;
                
                // 直接显示投递记录，不获取公司信息
                applications.forEach(application => {
                    const applyDate = new Date(application.applyTime).toLocaleDateString('zh-CN');
                    
                    // 状态转换
                    let statusText = '待处理';
                    let statusClass = 'bg-warning text-dark';
                    
                    if (application.status === 'ACCEPTED') {
                        statusText = '已通过';
                        statusClass = 'bg-success text-white';
                    } else if (application.status === 'REJECTED') {
                        statusText = '已拒绝';
                        statusClass = 'bg-danger text-white';
                    } else if (application.status === 'INTERVIEWED') {
                        statusText = '已面试';
                        statusClass = 'bg-info text-white';
                    }
                    
                    const tableBody = document.getElementById('applicationsTableBody');
                    tableBody.innerHTML += `
                    <tr>
                        <td>${application.id}</td>
                        <td>${application.jobId}</td>
                        <td>${applyDate}</td>
                        <td><span class="badge ${statusClass}" style="font-size: 0.85em; padding: 0.5em 0.75em; border-radius: 6px;">${statusText}</span></td>
                    </tr>`;
                });
            })
            .catch(err => {
                console.error('加载投递记录失败', err);
                myApplicationsDiv.innerHTML = '<p class="text-danger">加载投递记录失败</p>';
            });
    }
    
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            
            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error('解析Token失败', e);
            return null;
        }
    }
    
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function applyJob(jobId) {
        let token = getCookie('token') || localStorage.getItem('jwtToken');
        let user = parseJwt(token);
        if (!user || user.role !== 'jobseeker') {
            alert('请先以求职者身份登录后再投递！');
            window.location.href = 'login.html';
            return;
        }
        const application = { jobId: jobId, candidateId: user.id };
        fetch('http://localhost:9501/jobs/apply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(application)
        })
            .then(res=>res.text())
            .then(msg=>{ alert(msg); })
            .catch(()=>{ alert('投递失败，请稍后重试'); });
    }

    function viewJobDetail(jobId) {
        fetch(`http://localhost:9501/jobs/${jobId}`)
            .then(res => res.json())
            .then(job => {
                const content = `
            <h4>职位详情</h4>
            <p><strong>职位名称：</strong> ${job.title}</p>
            <p><strong>地点：</strong> ${job.location}</p>
            <p><strong>薪资：</strong> ${job.salary}</p>
            <p><strong>职位要求：</strong> ${job.requirements}</p>
            <p><strong>职位描述：</strong> ${job.description}</p>
            <p><strong>发布时间：</strong> ${new Date(job.createdTime).toLocaleString()}</p>
            <button class="btn btn-secondary" onclick="loadPage('job-list')">返回列表</button>`;
                document.getElementById('mainContent').innerHTML = content;
            })
            .catch(() => {
                document.getElementById('mainContent').innerHTML = '<p class="text-danger">加载职位详情失败</p>';
            });
    }

    function logout() {
        alert("已退出登录");
        window.location.href = "http://localhost:9501/index.html";
    }

    function searchJobs() {
        const keyword = document.getElementById("searchKeyword").value;
        if (!keyword.trim()) {
            alert("请输入搜索关键词");
            return;
        }
        
        const searchResult = document.getElementById("searchResult");
        searchResult.innerHTML = '<tr><td colspan="5" class="text-center">搜索中...</td></tr>';
        
        fetch(`http://localhost:9501/jobs/search?keyword=${keyword}`)
            .then(res => res.json())
            .then(data => {
                if (!data || data.length === 0) {
                    searchResult.innerHTML = '<tr><td colspan="5" class="text-center">没有找到匹配的职位</td></tr>';
                    return;
                }
                
                searchResult.innerHTML = '';
                data.forEach(job => {
                    searchResult.innerHTML += `<tr>
                        <td>${job.title || '未知'}</td>
                        <td>${job.employerId || '未知'}</td>
                        <td>${job.location || '未知'}</td>
                        <td>${job.salary || '未知'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="applyJob(${job.id})">投递</button>
                            <button class="btn btn-sm btn-info" onclick="viewJobDetail(${job.id})">查看详情</button>
                        </td>
                    </tr>`;
                });
            })
            .catch(error => {
                console.error("搜索失败:", error);
                searchResult.innerHTML = '<tr><td colspan="5" class="text-danger text-center">搜索失败，请稍后重试</td></tr>';
            });
    }

    // 面试相关功能
    function loadMyInterviews() {
        console.log("开始加载面试列表...");
        let token = getCookie('token') || localStorage.getItem('jwtToken');
        let user = parseJwt(token);
        if (!user) {
            console.error("无法解析用户信息");
            document.getElementById('interviewList').innerHTML = '<p class="text-danger">请先登录查看面试</p>';
            return;
        }
        
        console.log("解析的用户信息:", user);
        const userId = user.id || user.user_id;
        if (!userId) {
            console.error("无法获取用户ID");
            document.getElementById('interviewList').innerHTML = '<p class="text-danger">获取用户信息失败</p>';
            return;
        }
        
        console.log("开始发送面试列表请求, 用户ID:", userId);
        fetch(`/interviews/user/${userId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(res => {
            console.log("面试列表API响应状态:", res.status);
            if (!res.ok) {
                throw new Error(`HTTP错误! 状态: ${res.status}`);
            }
            return res.json();
        })
        .then(response => {
            console.log('面试列表数据:', response);
            // 处理嵌套在data字段中的面试数据
            const interviews = Array.isArray(response) ? response : (response.data || []);
            console.log('处理后的面试数据:', interviews);
            renderInterviews(interviews);
        })
        .catch(error => {
            console.error('获取面试列表失败:', error);
            document.getElementById('interviewList').innerHTML = '<p class="text-danger">获取面试列表失败: ' + error.message + '</p>';
        });
    }

    function renderInterviews(interviews) {
        const interviewList = document.getElementById('interviewList');
        if (!interviewList) return;
        
        if (!interviews || interviews.length === 0) {
            interviewList.innerHTML = '<p class="text-center">暂无面试安排</p>';
            return;
        }
        
        let html = `
        <table class="table table-bordered table-hover">
            <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <tr>
                    <th>面试ID</th>
                    <th>职位</th>
                    <th>面试时间</th>
                    <th>面试类型</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="interviewsTableBody"></tbody>
        </table>`;
        
        interviewList.innerHTML = html;
        
        interviews.forEach(interview => {
            const interviewDate = new Date(interview.scheduledTime).toLocaleString('zh-CN');
            
            // 面试状态样式
            let statusClass = 'badge badge-warning';
            switch(interview.status) {
                case 'SCHEDULED':
                    statusClass = 'badge badge-primary';
                    break;
                case 'COMPLETED':
                    statusClass = 'badge badge-success';
                    break;
                case 'CANCELLED':
                    statusClass = 'badge badge-danger';
                    break;
            }
            
            const tableBody = document.getElementById('interviewsTableBody');
            tableBody.innerHTML += `
            <tr>
                <td>${interview.id}</td>
                <td>${interview.jobId}</td>
                <td>${interviewDate}</td>
                <td>${interview.interviewType}</td>
                <td><span class="${statusClass}">${interview.status}</span></td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="viewInterviewDetail(${interview.id})">查看详情</button>
                </td>
            </tr>`;
        });
    }

    function viewInterviewDetail(interviewId) {
        let token = getCookie('token') || localStorage.getItem('jwtToken');
        
        // 使用相对路径，通过网关转发
        fetch(`/interviews/${interviewId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(res => res.json())
        .then(response => {
            console.log('获取到面试详情:', response);
            
            // 处理嵌套在data字段中的面试数据
            const interview = response.data || response;
            
            if (!interview || !interview.id) {
                console.error('面试数据无效:', interview);
                throw new Error('获取到的面试数据无效');
            }
            
            const interviewDate = interview.scheduledTime ? new Date(interview.scheduledTime).toLocaleString() : '未设置';
            
            // 创建详情模态框
            const modalHTML = `
                <div class="modal fade" id="interviewDetailModal" tabindex="-1" role="dialog" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">面试详情</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p><strong>面试ID：</strong> ${interview.id}</p>
                                <p><strong>职位ID：</strong> ${interview.jobId || '未设置'}</p>
                                <p><strong>面试时间：</strong> ${interviewDate}</p>
                                <p><strong>面试地点：</strong> ${interview.location || '未设置'}</p>
                                <p><strong>面试类型：</strong> ${interview.interviewType || '未设置'}</p>
                                <p><strong>面试官：</strong> ${interview.interviewer || '未设置'}</p>
                                <p><strong>当前状态：</strong> ${interview.status || '未设置'}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // 添加模态框到页面并显示
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            $('#interviewDetailModal').modal('show');
            
            // 模态框关闭后从DOM中移除
            $('#interviewDetailModal').on('hidden.bs.modal', function () {
                document.getElementById('interviewDetailModal').remove();
            });
        })
        .catch(error => {
            console.error('获取面试详情失败:', error);
            alert('获取面试详情失败');
        });
    }

    // 通知相关功能
    function loadUserNotifications() {
        console.log("开始加载通知...");
        let token = getCookie('token') || localStorage.getItem('jwtToken');
        console.log("Token是否存在:", !!token);
        let user = parseJwt(token);
        if (!user) {
            console.error("无法解析用户信息");
            document.getElementById('notificationList').innerHTML = '<p class="text-danger">请先登录查看通知</p>';
            return;
        }
        
        console.log("解析的用户信息:", user);
        const userId = user.id || user.user_id;
        if (!userId) {
            console.error("无法获取用户ID");
            document.getElementById('notificationList').innerHTML = '<p class="text-danger">获取用户信息失败</p>';
            return;
        }
        
        console.log("开始发送通知请求, 用户ID:", userId);
        fetch(`/api/notifications/user/${userId}?page=0&amp;size=50`, {
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(res => {
            console.log("通知API响应状态:", res.status);
            if (!res.ok) {
                throw new Error(`HTTP错误! 状态: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            console.log('通知数据:', data);
            const notifications = data.data?.content || [];
            renderUserNotifications(notifications);
            updateUserNotificationStats(notifications);
        })
        .catch(error => {
            console.error('获取通知失败:', error);
            document.getElementById('notificationList').innerHTML = '<p class="text-danger">获取通知失败</p>';
        });
    }

    function renderUserNotifications(notifications) {
        const container = document.getElementById('notificationList');
        
        if (!notifications || notifications.length === 0) {
            container.innerHTML = '<p class="text-center">暂无通知</p>';
            return;
        }
        
        let html = '';
        notifications.forEach(notification => {
            const isUnread = !notification.isRead;
            const timeAgo = getTimeAgo(new Date(notification.createdAt));
            
            html += `
                <div class="card mb-3 ${isUnread ? 'border-left-warning' : ''}" style="border-left: ${isUnread ? '4px solid #ffc107' : 'none'}">
                    <div class="card-body">
                        <h5 class="card-title">${notification.title}</h5>
                        <p class="card-text">${notification.content.replace(/\n/g, '<br />')}</p>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">${timeAgo}</small>
                            <div>
                                <span class="badge badge-primary mr-2">${notification.type}</span>
                                ${isUnread ? `<button class="btn btn-sm btn-success" onclick="markNotificationAsRead(${notification.id})">标记已读</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    function updateUserNotificationStats(notifications) {
        if (!notifications) return;
        
        const total = notifications.length;
        const unread = notifications.filter(n => !n.isRead).length;
        const today = notifications.filter(n => {
            const today = new Date();
            const notificationDate = new Date(n.createdAt);
            return notificationDate.toDateString() === today.toDateString();
        }).length;
        
        document.getElementById('totalNotifications').textContent = total;
        document.getElementById('unreadNotifications').textContent = unread;
        document.getElementById('todayNotifications').textContent = today;
    }

    function getTimeAgo(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (days > 0) return `${days}天前`;
        if (hours > 0) return `${hours}小时前`;
        if (minutes > 0) return `${minutes}分钟前`;
        return '刚刚';
    }

    function markNotificationAsRead(notificationId) {
        let token = getCookie('token') || localStorage.getItem('jwtToken');
        
        // 使用相对路径，通过网关转发
        fetch(`/api/notifications/${notificationId}/read`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success || data.code === 200) {
                alert('通知已标记为已读');
                loadUserNotifications(); // 重新加载通知
            } else {
                alert(data.message || '操作失败');
            }
        })
        .catch(error => {
            console.error('标记已读失败:', error);
            alert('标记已读失败');
        });
    }

    function markAllNotificationsAsRead() {
        let token = getCookie('token') || localStorage.getItem('jwtToken');
        let user = parseJwt(token);
        if (!user) {
            alert('获取用户信息失败');
            return;
        }
        
        const userId = user.id || user.user_id;
        
        // 使用相对路径，通过网关转发
        fetch(`/api/notifications/user/${userId}/read-all`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success || data.code === 200) {
                alert('所有通知已标记为已读');
                loadUserNotifications(); // 重新加载通知
            } else {
                alert(data.message || '操作失败');
            }
        })
        .catch(error => {
            console.error('全部标记已读失败:', error);
            alert('操作失败');
        });
    }

    // 添加页面初始化代码
    document.addEventListener('DOMContentLoaded', function() {
        console.log("页面已加载，添加侧边栏点击事件监听");
        // 为所有侧边栏链接添加点击事件
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.addEventListener('click', function() {
                console.log("点击了侧边栏链接:", this.textContent);
                // 移除所有激活状态
                document.querySelectorAll('.sidebar a').forEach(a => {
                    a.classList.remove('active');
                });
                // 添加激活状态
                this.classList.add('active');
            });
        });
        
        // 获取当前登录状态
        const token = getCookie('token') || localStorage.getItem('jwtToken');
        if (token) {
            try {
                const user = parseJwt(token);
                console.log("当前登录用户:", user);
                document.getElementById('userDropdown').textContent = user.sub || user.username || '用户';
            } catch (error) {
                console.error("解析用户信息失败:", error);
            }
        } else {
            console.log("用户未登录");
        }
    });
</script>
</body>
</html>