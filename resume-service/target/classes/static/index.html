<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>个人信息中心</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
<div class="container">
    <h2 class="mb-4">我的简历中心</h2>

    <div class="mb-3">
        <button class="btn btn-primary me-2" onclick="showCreateForm()">创建新简历</button>
    </div>

    <!-- 简历列表 -->
    <table class="table table-bordered" id="resumeTable">
        <thead>
        <tr>
            <th>#</th>
            <th>姓名</th>
            <th>电话</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody id="resumeList">
        </tbody>
    </table>
</div>

<!-- 创建简历弹窗 -->
<div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="createForm" novalidate>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建简历</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">简历操作</label>
                    <select id="createOption" class="form-select" required>
                        <option value="edit">进入编辑页面</option>
                        <option value="upload">上传 PDF/Word 文件</option>
                    </select>

                    <div id="fileUploadGroup" class="mt-3 d-none">
                        <label class="form-label">上传文件</label>
                        <input type="file" name="file" class="form-control" accept=".pdf,.doc,.docx" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">确定</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script>
    $(function () {
        function loadResumes() {
            $.get("/api/resume", function (data) {
                $("#resumeList").empty();
                data.forEach((item, index) => {
                    $("#resumeList").append(`
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.name ? item.name : '未填写'}</td>
                        <td>${item.phone ? item.phone : '未填写'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editResume(${item.id})">编辑</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteResume(${item.id})">删除</button>
                        </td>
                    </tr>
                `);
                });
            });
        }

        $('#createOption').on('change', function () {
            const fileInput = $('#fileUploadGroup input[name="file"]');
            if ($(this).val() === 'upload') {
                $('#fileUploadGroup').removeClass('d-none');
                fileInput.prop('required', true);
            } else {
                $('#fileUploadGroup').addClass('d-none');
                fileInput.prop('required', false);
            }
        });

        window.showCreateForm = function () {
            $('#createForm')[0].reset();
            $('#fileUploadGroup').addClass('d-none');
            new bootstrap.Modal(document.getElementById('createModal')).show();
        }

        $('#createForm').on('submit', function (e) {
            e.preventDefault();
            const option = $('#createOption').val();

            $.ajax({
                url: "/resume",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    personalInfo: {
                        name: "新简历",
                        phone: ""
                    }
                }),
                success: function (res) {
                    const resumeId = res.resumeId;

                    if (option === 'edit') {
                        window.location.href = `/edit_resume.html?id=${resumeId}`;
                    } else {
                        const fileInput = $('#fileUploadGroup input[name="file"]')[0];
                        const file = fileInput.files[0];
                        if (!file) {
                            alert("请先选择文件！");
                            return;
                        }

                        const formData = new FormData();
                        formData.append("file", file);

                        $.ajax({
                            url: `/resume/${resumeId}/upload`,
                            method: "POST",
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function () {
                                alert("上传成功！");
                                $('#createModal').modal('hide');
                                loadResumes();
                            },
                            error: function (xhr) {
                                alert("上传失败：" + xhr.responseText);
                            }
                        });
                    }
                },
                error: function (xhr) {
                    console.error("简历创建失败", xhr);
                    alert("简历创建失败：" + xhr.responseText);
                }
            });
        });

        window.editResume = function (id) {
            window.location.href = `/edit_resume.html?id=${id}`;
        }

        window.deleteResume = function (id) {
            if (confirm("确定删除此简历吗？")) {
                $.ajax({
                    url: `/resume/${id}`,
                    method: "DELETE",
                    success: function () {
                        alert("删除成功");
                        loadResumes();
                    },
                    error: function () {
                        alert("删除失败");
                    }
                });
            }
        }

        loadResumes();
    });
</script>
</body>
</html>
